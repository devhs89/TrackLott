<mat-card class="row col-xl-9 mx-auto mb-3 mat-elevation-z6">
  <mat-card-title>Add Combinations</mat-card-title>
  <mat-divider class="my-3" inset></mat-divider>
  <mat-card-content>
    <form (ngSubmit)="onSaveCombinations()" [formGroup]="addCombosForm" autocomplete="off">
      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Lottery Name</mat-label>
            <mat-select (selectionChange)="onLotterySelect($event)" formControlName="lotteryNameControl">
              <mat-option *ngFor="let lotto of lotterySelectOption | keyvalue"
                          value="{{lotto.key}}">{{lotto.value.name}}
              </mat-option>
            </mat-select>
            <mat-hint>Select a lottery name</mat-hint>
            <mat-error>Invalid lottery name</mat-error>
          </mat-form-field>
        </div>

        <div class="col-12 col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Purchase Date</mat-label>
            <input [matDatepicker]="purchaseDatePicker" [max]="maxDate" [min]="minDate"
                   formControlName="purchaseDateControl"
                   matInput
                   placeholder="dd/mm/yyyy">
            <mat-datepicker-toggle [for]="purchaseDatePicker" matSuffix></mat-datepicker-toggle>
            <mat-datepicker #purchaseDatePicker [touchUi]="(isHandset$ | async)"></mat-datepicker>
            <mat-hint>When were/would these combinations be played?</mat-hint>
            <mat-error>Invalid date</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12 col-md-6">

          <div class="row">
            <div class="col-12 mb-3">
              <div
                *ngIf="(currPickedNums.primaryNumbers && currPickedNums.primaryNumbers.length > 0) || (currPickedNums.secondaryNumbers && currPickedNums.secondaryNumbers.length > 0); else showBlank"
                class="border rounded-3 p-2 mb-2">

                <ng-container *ngTemplateOutlet="currentPickedNumbers"></ng-container>

                <div class="w-100 pt-1 justify-content-end text-end">
                  <button (click)="currPickedNums.primaryNumbers = []; currPickedNums.secondaryNumbers = [];"
                          class="text-uppercase"
                          color="warn" mat-flat-button
                          type="button">
                    Clear
                  </button>
                  <button (click)="onAddCombination()"
                          *ngIf="currPickedNums.primaryNumbers.length >= selectedGameOption.standard"
                          class="ms-2 text-uppercase" color="primary"
                          mat-flat-button
                          type="button">
                    Add
                  </button>
                </div>
              </div>

              <ng-container *ngIf="!(isHandset$ | async)">
                <ng-container *ngTemplateOutlet="allPickedNumbers"></ng-container>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="border rounded-3 p-2 justify-content-center text-center">
            <button (click)="onMainNumClick(num)" *ngFor="let num of selectedGameOption.primaryNumbers"
                    [disabled]="allCombinations.length >= 10" class="m-1"
                    color="primary"
                    mat-mini-fab
                    type="button">{{num}}</button>
          </div>
          <div *ngIf="selectedGameOption.name === lotterySelectOption.powerball.name"
               class="border mt-2 rounded-3 p-2 justify-content-center text-center">
            <button (click)="onJackpotNumClick(num)" *ngFor="let num of selectedGameOption.secondaryNumbers"
                    [disabled]="allCombinations.length >= 10" class="m-1"
                    color="warn" mat-mini-fab
                    type="button">{{num}}</button>
          </div>
        </div>

        <ng-container *ngIf="(isHandset$ | async)">
          <ng-container *ngTemplateOutlet="allPickedNumbers"></ng-container>
        </ng-container>
      </div>

      <mat-divider class="mb-2" inset></mat-divider>
      <div class="d-flex justify-content-center">
        <button class="w-50 text-uppercase" color="primary" mat-flat-button type="submit">
          Save
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<ng-template #numbersSvg let-options>
  <svg class="mt-1 mx-1 rounded-circle shadow-num-btn" height="40" viewBox="0 0 40 40" width="40"
       xmlns="http://www.w3.org/2000/svg">
    <style>
      .textNum {
        font: 400 1.1rem 'Roboto Mono', monospace;
      }
    </style>
    <g>
      <circle [ngStyle]="{'fill': options.bgFill}" cx="20" cy="20" r="20"></circle>
      <text [ngStyle]="{'fill': options.txtColor}" class="textNum" text-anchor="middle" x="20"
            y="26">{{options.number}}</text>
    </g>
  </svg>
</ng-template>

<ng-template #currentPickedNumbers>
  <ng-container *ngFor="let num of currPickedNums.primaryNumbers">
    <ng-container
      *ngTemplateOutlet="numbersSvg;
      context: {$implicit: {number: num, bgFill: '#ffd740', txtColor: '#343a40'}}"></ng-container>
  </ng-container>
  <ng-container *ngIf="currPickedNums.secondaryNumbers && currPickedNums.secondaryNumbers.length > 0">
    <ng-container
      *ngTemplateOutlet="numbersSvg;
      context: {$implicit: {number: currPickedNums.secondaryNumbers, bgFill: '#F44336FF', txtColor: 'white'}}"></ng-container>
  </ng-container>
</ng-template>

<ng-template #allPickedNumbers>
  <div class="col-12">
    <ng-container *ngIf="allCombinations">
      <mat-card *ngFor="let row of allCombinations; index as dex" class="mb-2 p-2">
        <div class="d-flex justify-content-between">
          <div class="d-inline-flex flex-column justify-content-center">
            <span class="mx-2" style="font-size: 1.2rem;">#{{allCombinations.length - dex}}</span>
          </div>
          <button (click)="onClear(dex)" mat-icon-button>
            <mat-icon>clear</mat-icon>
          </button>
        </div>
        <mat-divider class="mb-2" inset></mat-divider>
        <mat-card-content>
          <ng-container *ngFor="let num of row.pickedNumbers.primaryNumbers">
            <ng-container
              *ngTemplateOutlet="numbersSvg; context: {$implicit: {number: num, bgFill: '#ffd740', txtColor: '#343a40'}}"></ng-container>
          </ng-container>
          <ng-container *ngIf="row.pickedNumbers.secondaryNumbers && row.pickedNumbers.secondaryNumbers.length > 0">
            <ng-container
              *ngTemplateOutlet="numbersSvg; context: {$implicit: {number: row.pickedNumbers.secondaryNumbers, bgFill: '#F44336FF', txtColor: 'white'}}"></ng-container>
          </ng-container>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </div>
</ng-template>

<ng-template #showBlank>
  <div class="border rounded-3 p-2 mb-2">
    <small *ngIf="allCombinations.length < 10; else limitReached" class="text-secondary">
      Click on numbers on the right to add them as a combination.</small>
    <ng-template #limitReached>
      <small class="text-warning">
        Maximum number of combinnations selected. Please save current combinations to add more.</small>
    </ng-template>
  </div>
</ng-template>
