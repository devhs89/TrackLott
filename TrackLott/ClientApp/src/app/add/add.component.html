<mat-card class="row col-xl-9 mx-auto mb-3 mat-elevation-z6">
  <mat-card-title>Add Combinations</mat-card-title>
  <mat-divider inset class="my-3"></mat-divider>
  <mat-card-content>
    <form [formGroup]="addCombosForm" (ngSubmit)="onSaveCombinations()" autocomplete="off">

      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Lottery Name</mat-label>
            <mat-select formControlName="lotteryNameControl" (selectionChange)="onLotterySelect($event)">
              <mat-option *ngFor="let lotto of lotteryNames | keyvalue"
                          value="{{lotto.key}}">{{lotto.value.name}}</mat-option>
            </mat-select>
            <mat-hint>Select a lottery name</mat-hint>
            <mat-error>Invalid lottery name</mat-error>
          </mat-form-field>
        </div>

        <div class="col-12 col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Date</mat-label>
            <!--suppress TypeScriptValidateTypes -->
            <input matInput formControlName="dateAddedControl" [min]="minDate" [max]="maxDate"
                   placeholder="dd/mm/yyyy"
                   [matDatepicker]="playedDatePicker">
            <mat-datepicker-toggle matSuffix [for]="playedDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #playedDatePicker [touchUi]="(isHandset$ | async)"></mat-datepicker>
            <mat-hint>When were/would these combinations be played?</mat-hint>
            <mat-error>Invalid date</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12 col-md-6">

          <div class="row">
            <div class="col-12 mb-3">
              <div class="border rounded-3 p-2 mb-2"
                   *ngIf="(currPickedNums.mainNums && currPickedNums.mainNums.length > 0) || (currPickedNums.jackpot && currPickedNums.jackpot > 0); else showBlank">

                <ng-container *ngTemplateOutlet="currentPickedNumbers"></ng-container>

                <div class="w-100 pt-1 justify-content-end text-end">
                  <button mat-flat-button type="button" color="warn" class="text-uppercase"
                          (click)="currPickedNums.mainNums = []; currPickedNums.jackpot = 0;">
                    Clear
                  </button>
                  <button mat-flat-button type="button" color="primary" class="ms-2 text-uppercase"
                          (click)="onAddCombination()"
                          *ngIf="currPickedNums.mainNums.length >= lotteryNameSelected.standard">
                    Add
                  </button>
                </div>
              </div>

              <ng-container *ngIf="!(isHandset$ | async)">
                <ng-container *ngTemplateOutlet="allPickedNumbers"></ng-container>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6" [ngClass]="{'mb-3': (isHandset$ | async)}">
          <div class="border rounded-3 p-2 justify-content-center text-center">
            <button mat-mini-fab type="button" class="m-1" color="primary"
                    (click)="onMainNumClick(num)"
                    [disabled]="allPickedNums.length >= 10"
                    *ngFor="let num of lotteryNameSelected.mainNums">{{num}}</button>
          </div>
          <div class="border mt-2 rounded-3 p-2 justify-content-center text-center"
               *ngIf="lotteryNameSelected.name === 'Powerball'">
            <button mat-mini-fab type="button" class="m-1" color="warn"
                    (click)="onJackpotNumClick(num)" [disabled]="allPickedNums.length >= 10"
                    *ngFor="let num of lotteryNameSelected.jackpotNums">{{num}}</button>
          </div>
        </div>

        <ng-container *ngIf="(isHandset$ | async)">
          <ng-container *ngTemplateOutlet="allPickedNumbers"></ng-container>
        </ng-container>
      </div>

      <div class="d-flex justify-content-center my-3">
        <button mat-flat-button type="submit" color="primary" class="w-50 text-uppercase">
          Save
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<ng-template #numbersSvg let-options>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="40" height="40"
       class="mt-1 mx-1 rounded-circle shadow-num-btn">
    <style>
      .textNum {
        font: 400 1.1rem 'Roboto Mono', monospace;
      }
    </style>
    <g>
      <circle r="20" cx="20" cy="20" [ngStyle]="{'fill': options.bgFill}"></circle>
      <text x="20" y="26" text-anchor="middle" class="textNum"
            [ngStyle]="{'fill': options.txtColor}">{{options.number}}</text>
    </g>
  </svg>
</ng-template>

<ng-template #currentPickedNumbers>
  <ng-container *ngFor="let num of currPickedNums.mainNums">
    <ng-container
      *ngTemplateOutlet="numbersSvg;
      context: {$implicit: {number: num, bgFill: '#ffd740', txtColor: '#343a40'}}"></ng-container>
  </ng-container>
  <ng-container *ngIf="currPickedNums.jackpot && currPickedNums.jackpot > 0">
    <ng-container
      *ngTemplateOutlet="numbersSvg;
      context: {$implicit: {number: currPickedNums.jackpot, bgFill: '#F44336FF', txtColor: 'white'}}"></ng-container>
  </ng-container>
</ng-template>

<ng-template #allPickedNumbers>
  <div class="col-12">
    <ng-container *ngIf="allPickedNums">
      <mat-card class="mb-2 p-2" *ngFor="let row of allPickedNums; index as dex">
        <div class="d-flex justify-content-between">
          <div class="d-inline-flex flex-column justify-content-center">
            <span style="font-size: 1.2rem;" class="mx-2">#{{allPickedNums.length - dex}}</span>
          </div>
          <button mat-icon-button (click)="onClear(dex)">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
        <mat-divider inset class="mb-2"></mat-divider>
        <mat-card-content>
          <ng-container *ngFor="let num of row.mainNums">
            <ng-container
              *ngTemplateOutlet="numbersSvg; context: {$implicit: {number: num, bgFill: '#ffd740', txtColor: '#343a40'}}"></ng-container>
          </ng-container>
          <ng-container *ngIf="row.jackpot && row.jackpot > 0">
            <ng-container
              *ngTemplateOutlet="numbersSvg; context: {$implicit: {number: row.jackpot, bgFill: '#F44336FF', txtColor: 'white'}}"></ng-container>
          </ng-container>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </div>
</ng-template>

<ng-template #showBlank>
  <div class="border rounded-3 p-2 mb-2">
    <small class="text-secondary" *ngIf="allPickedNums.length < 10; else limitReached">
      Click on numbers on the right to add them as a combination.</small>
    <ng-template #limitReached>
      <small class="text-warning">
        Maximum number of combinnations selected. Please save current combinations to add more.</small>
    </ng-template>
  </div>
</ng-template>
